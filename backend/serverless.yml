service: music-maker-backend

frameworkVersion: "4"

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  # OpenAI calls often exceed the default 6s.
  timeout: 30
  environment:
    ALLOWED_ORIGINS: ${self:custom.allowedOriginsByStage.${sls:stage}, self:custom.allowedOriginsByStage.dev}
    # Do NOT commit secrets. Provide these via your shell env (local) or CI/Serverless deploy env.
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    OPENAI_MODEL: ${env:OPENAI_MODEL, 'gpt-5.2'}
    # Optional override for testing/proxies.
    OPENAI_BASE_URL: ${env:OPENAI_BASE_URL, 'https://api.openai.com/v1/responses'}

plugins:
  - serverless-offline

custom:
  serverless-offline:
    # Keep local behavior aligned with provider.timeout.
    lambdaTimeout: 30
  allowedOriginsByStage:
    dev: http://localhost:5173,http://localhost:3000
    prod: https://benlirio.com,https://www.benlirio.com

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: node20
    platform: node

functions:
  ping:
    handler: src/handler.ping
    events:
      - http:
          path: ping
          method: get
      - http:
          path: ping
          method: options

  generatePython:
    handler: src/handler.generatePython
    timeout: 30
    events:
      - http:
          path: generate-python
          method: post
      - http:
          path: generate-python
          method: options

  midiToMusicXml:
    handler: src/handler.midiToMusicXml
    timeout: 30
    events:
      - http:
          path: midi-to-musicxml
          method: post
      - http:
          path: midi-to-musicxml
          method: options

package:
  individually: true

resources:
  Resources:
    # Ensure API Gateway-generated errors include CORS headers.
    # Without this, the browser often reports a generic "CORS error" even when
    # the real failure is a 4XX/5XX generated by API Gateway.
    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Accept,Authorization'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"

    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Accept,Authorization'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"

service: music-maker-backend

frameworkVersion: "4"

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  # Required to use API Gateway integration timeouts > 29s.
  # (The AWS feature applies to Regional/private REST APIs, not EDGE.)
  endpointType: REGIONAL
  # OpenAI calls often exceed the default 6s.
  # Note: API Gateway sync requests will still time out unless the per-method
  # integration timeout is also raised (see resources.extensions below).
  timeout: ${env:LAMBDA_TIMEOUT_SECONDS, 60}
  environment:
    ALLOWED_ORIGINS: ${self:custom.allowedOriginsByStage.${sls:stage}, self:custom.allowedOriginsByStage.dev}
    # Do NOT commit secrets. Provide these via your shell env (local) or CI/Serverless deploy env.
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    OPENAI_MODEL: ${env:OPENAI_MODEL, 'gpt-5.2'}
    # Large cap; the OpenAI API/model will still enforce a hard maximum.
    OPENAI_MAX_OUTPUT_TOKENS: ${env:OPENAI_MAX_OUTPUT_TOKENS, '100000'}
    # Should be <= API Gateway integration timeout (in ms).
    OPENAI_TIMEOUT_MS: ${env:OPENAI_TIMEOUT_MS, '55000'}
    # Optional override for testing/proxies.
    OPENAI_BASE_URL: ${env:OPENAI_BASE_URL, 'https://api.openai.com/v1/responses'}

plugins:
  - serverless-offline
  - serverless-python-requirements

custom:
  serverless-offline:
    # Keep local behavior aligned with provider.timeout.
    lambdaTimeout: ${env:LAMBDA_TIMEOUT_SECONDS, 60}
    # serverless-offline uses a separate "lambda server" port; 3002 is commonly
    # occupied by other dev tools. Keep HTTP on 3000 to match VITE_BACKEND_URL.
    httpPort: 3000
    lambdaPort: 3003
  pythonRequirements:
    dockerizePip: non-linux
    slim: true
    strip: false
  allowedOriginsByStage:
    dev: http://localhost:5173,http://localhost:3000
    prod: https://benlirio.com,https://www.benlirio.com

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: node20
    platform: node

functions:
  ping:
    handler: src/handler.ping
    events:
      - http:
          path: ping
          method: get
      - http:
          path: ping
          method: options

  generatePython:
    handler: src/handler.generatePython
    timeout: ${env:LAMBDA_TIMEOUT_SECONDS, 60}
    events:
      - http:
          path: generate-python
          method: post
      - http:
          path: generate-python
          method: options

  midiToMusicXml:
    runtime: python3.12
    handler: src/midi_to_musicxml_handler.lambda_handler
    timeout: ${env:LAMBDA_TIMEOUT_SECONDS, 60}
    events:
      - http:
          path: midi-to-musicxml
          method: post
      - http:
          path: midi-to-musicxml
          method: options

package:
  individually: true
  patterns:
    - "!**/.venv/**"
    - "!**/__pycache__/**"
    - "!**/*.pyc"
    - "!**/.env"
    - "!**/.env.*"
    - "!node_modules/**"

resources:
  # Serverless does not currently expose REST API integration timeouts as a
  # first-class setting. We extend the generated AWS::ApiGateway::Method
  # resources to set Integration.TimeoutInMillis.
  #
  # This is what allows sync API Gateway requests to exceed the historic 29s
  # limit (Regional/private REST APIs only). Raising this may require reducing
  # your account-level throttle quota limit.
  extensions:
    # POST /generate-python
    ApiGatewayMethodGenerateDashpythonPost:
      Properties:
        Integration:
          TimeoutInMillis: ${env:APIGW_INTEGRATION_TIMEOUT_MS, 60000}
    # POST /midi-to-musicxml
    ApiGatewayMethodMidiDashtoDashmusicxmlPost:
      Properties:
        Integration:
          TimeoutInMillis: ${env:APIGW_INTEGRATION_TIMEOUT_MS, 60000}
  Resources:
    # Ensure API Gateway-generated errors include CORS headers.
    # Without this, the browser often reports a generic "CORS error" even when
    # the real failure is a 4XX/5XX generated by API Gateway.
    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Accept,Authorization'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"

    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: ApiGatewayRestApi
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Accept,Authorization'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
